<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba del Sistema - Gesti√≥n de Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-pass {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-pending {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        #testOutput {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">üß™ Prueba del Sistema de Gesti√≥n de Usuarios</h1>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Estado de las Pruebas</h5>
            </div>
            <div class="card-body">
                <div id="testSummary" class="mb-3">
                    <span class="badge bg-secondary">Total: <span id="totalTests">0</span></span>
                    <span class="badge bg-success">Pasadas: <span id="passedTests">0</span></span>
                    <span class="badge bg-danger">Fallidas: <span id="failedTests">0</span></span>
                    <span class="badge bg-warning">Pendientes: <span id="pendingTests">0</span></span>
                </div>
                <button id="btnRunTests" class="btn btn-primary">‚ñ∂Ô∏è Ejecutar Todas las Pruebas</button>
                <button id="btnClearTests" class="btn btn-secondary">üóëÔ∏è Limpiar Resultados</button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìã Resultados de las Pruebas</h5>
            </div>
            <div class="card-body">
                <div id="testOutput"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { API, ApiError, Logger } from './js/api.js';
        import { UI } from './js/ui.js';

        // Contadores de pruebas
        let totalTests = 0;
        let passedTests = 0;
        let failedTests = 0;
        let pendingTests = 0;

        const output = document.getElementById('testOutput');

        function updateSummary() {
            document.getElementById('totalTests').textContent = totalTests;
            document.getElementById('passedTests').textContent = passedTests;
            document.getElementById('failedTests').textContent = failedTests;
            document.getElementById('pendingTests').textContent = pendingTests;
        }

        function logTest(title, status, message = '') {
            totalTests++;
            const div = document.createElement('div');
            div.className = 'test-result';

            if (status === 'pass') {
                div.classList.add('test-pass');
                passedTests++;
                div.innerHTML = `‚úÖ <strong>${title}</strong>: ${message || 'PAS√ì'}`;
            } else if (status === 'fail') {
                div.classList.add('test-fail');
                failedTests++;
                div.innerHTML = `‚ùå <strong>${title}</strong>: ${message || 'FALL√ì'}`;
            } else {
                div.classList.add('test-pending');
                pendingTests++;
                div.innerHTML = `‚è≥ <strong>${title}</strong>: ${message || 'PENDIENTE'}`;
            }

            output.appendChild(div);
            updateSummary();
        }

        function logSection(title) {
            const section = document.createElement('div');
            section.className = 'mt-4 mb-2';
            section.innerHTML = `<h5 class="text-primary">üîç ${title}</h5><hr>`;
            output.appendChild(section);
        }

        async function runTests() {
            // Limpiar resultados anteriores
            output.innerHTML = '';
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            pendingTests = 0;
            updateSummary();

            logSection('PRUEBAS DE VALIDACI√ìN - Password Hardcodeado Eliminado');

            // Test 1: Verificar que password null es v√°lido en edici√≥n
            try {
                const datosEdicion = {
                    nombre: 'Test Usuario',
                    email: 'test@example.com',
                    password: null
                };
                API.validarDatosUsuario(datosEdicion, true); // modo edici√≥n
                logTest('Password null en edici√≥n', 'pass', 'Se acepta password null correctamente');
            } catch (error) {
                logTest('Password null en edici√≥n', 'fail', error.message);
            }

            // Test 2: Verificar que password es obligatorio en creaci√≥n
            try {
                const datosCreacion = {
                    nombre: 'Test Usuario',
                    email: 'test@example.com',
                    password: null
                };
                API.validarDatosUsuario(datosCreacion, false); // modo creaci√≥n
                logTest('Password obligatorio en creaci√≥n', 'fail', 'Deber√≠a rechazar password null en creaci√≥n');
            } catch (error) {
                logTest('Password obligatorio en creaci√≥n', 'pass', 'Correctamente rechaza password null: ' + error.message);
            }

            logSection('PRUEBAS DE VALIDACI√ìN - Email Robusto');

            // Test 3: Email v√°lido simple
            try {
                const esValido = API.esEmailValido('juan@example.com');
                logTest('Email v√°lido simple', esValido ? 'pass' : 'fail', 'juan@example.com');
            } catch (error) {
                logTest('Email v√°lido simple', 'fail', error.message);
            }

            // Test 4: Email con subdominio
            try {
                const esValido = API.esEmailValido('user@mail.example.com');
                logTest('Email con subdominio', esValido ? 'pass' : 'fail', 'user@mail.example.com');
            } catch (error) {
                logTest('Email con subdominio', 'fail', error.message);
            }

            // Test 5: Email con plus
            try {
                const esValido = API.esEmailValido('user+tag@example.com');
                logTest('Email con plus (+)', esValido ? 'pass' : 'fail', 'user+tag@example.com');
            } catch (error) {
                logTest('Email con plus (+)', 'fail', error.message);
            }

            // Test 6: Email inv√°lido - sin @
            try {
                const esValido = API.esEmailValido('invalido.com');
                logTest('Rechazar email sin @', !esValido ? 'pass' : 'fail', 'Correctamente rechaza: invalido.com');
            } catch (error) {
                logTest('Rechazar email sin @', 'fail', error.message);
            }

            // Test 7: Email inv√°lido - doble @
            try {
                const esValido = API.esEmailValido('test@@example.com');
                logTest('Rechazar email con @@', !esValido ? 'pass' : 'fail', 'Correctamente rechaza: test@@example.com');
            } catch (error) {
                logTest('Rechazar email con @@', 'fail', error.message);
            }

            // Test 8: Email inv√°lido - TLD muy corto
            try {
                const esValido = API.esEmailValido('user@domain.c');
                logTest('Rechazar TLD de 1 caracter', !esValido ? 'pass' : 'fail', 'Correctamente rechaza: user@domain.c');
            } catch (error) {
                logTest('Rechazar TLD de 1 caracter', 'fail', error.message);
            }

            // Test 9: Email inv√°lido - puntos consecutivos
            try {
                const esValido = API.esEmailValido('user..name@example.com');
                logTest('Rechazar puntos consecutivos', !esValido ? 'pass' : 'fail', 'Correctamente rechaza: user..name@example.com');
            } catch (error) {
                logTest('Rechazar puntos consecutivos', 'fail', error.message);
            }

            logSection('PRUEBAS DE VALIDACI√ìN - Tipos de Par√°metros');

            // Test 10: ID v√°lido
            try {
                await API.obtenerUsuarioPorId(1);
                logTest('ID num√©rico v√°lido', 'pending', 'Depende de la conexi√≥n con backend');
            } catch (error) {
                if (error instanceof TypeError) {
                    logTest('ID num√©rico v√°lido', 'fail', error.message);
                } else {
                    logTest('ID num√©rico v√°lido', 'pass', 'Validaci√≥n de tipo correcta (error de API esperado)');
                }
            }

            // Test 11: ID inv√°lido - string
            try {
                await API.obtenerUsuarioPorId('abc');
                logTest('Rechazar ID string', 'fail', 'Deber√≠a rechazar string como ID');
            } catch (error) {
                if (error instanceof TypeError) {
                    logTest('Rechazar ID string', 'pass', 'Correctamente rechaza: ' + error.message);
                } else {
                    logTest('Rechazar ID string', 'fail', 'Error incorrecto: ' + error.message);
                }
            }

            // Test 12: ID inv√°lido - negativo
            try {
                await API.obtenerUsuarioPorId(-5);
                logTest('Rechazar ID negativo', 'fail', 'Deber√≠a rechazar ID negativo');
            } catch (error) {
                if (error instanceof TypeError) {
                    logTest('Rechazar ID negativo', 'pass', 'Correctamente rechaza: ' + error.message);
                } else {
                    logTest('Rechazar ID negativo', 'fail', 'Error incorrecto: ' + error.message);
                }
            }

            // Test 13: ID inv√°lido - cero
            try {
                await API.obtenerUsuarioPorId(0);
                logTest('Rechazar ID cero', 'fail', 'Deber√≠a rechazar ID = 0');
            } catch (error) {
                if (error instanceof TypeError) {
                    logTest('Rechazar ID cero', 'pass', 'Correctamente rechaza: ' + error.message);
                } else {
                    logTest('Rechazar ID cero', 'fail', 'Error incorrecto: ' + error.message);
                }
            }

            logSection('PRUEBAS DE SEGURIDAD - Escapado HTML');

            // Test 14: Escapar script tags
            try {
                const malicious = '<script>alert("XSS")</script>';
                const escaped = UI.escaparHTML(malicious);
                const isEscaped = escaped.includes('&lt;') && escaped.includes('&gt;') && !escaped.includes('<script>');
                logTest('Escapar <script> tags', isEscaped ? 'pass' : 'fail',
                    `Input: ${malicious} ‚Üí Output: ${escaped}`);
            } catch (error) {
                logTest('Escapar <script> tags', 'fail', error.message);
            }

            // Test 15: Escapar comillas
            try {
                const input = 'Test "quotes" here';
                const escaped = UI.escaparHTML(input);
                const isEscaped = escaped.includes('&quot;');
                logTest('Escapar comillas dobles', isEscaped ? 'pass' : 'fail',
                    `"${input}" contiene &quot;`);
            } catch (error) {
                logTest('Escapar comillas dobles', 'fail', error.message);
            }

            logSection('PRUEBAS DE CONEXI√ìN - API Backend');

            // Test 16: Verificar conexi√≥n
            try {
                logTest('Conectando al backend', 'pending', 'Verificando https://usuarios-mvgv.onrender.com/api/usuarios...');
                const conectado = await API.verificarConexion();
                logTest('Conexi√≥n con backend', conectado ? 'pass' : 'fail',
                    conectado ? 'Backend responde correctamente' : 'Backend no disponible (esperado en Render free tier)');
            } catch (error) {
                logTest('Conexi√≥n con backend', 'fail', error.message);
            }

            // Test 17: Obtener usuarios (depende de conexi√≥n)
            try {
                const usuarios = await API.obtenerUsuarios();
                logTest('Obtener lista de usuarios', 'pass', `Se obtuvieron ${usuarios.length} usuarios del backend`);
            } catch (error) {
                if (error.message.includes('tiempo de espera') || error.message.includes('fetch')) {
                    logTest('Obtener lista de usuarios', 'pending',
                        'Backend en sleep mode (Render free tier) - Reintentar en 30-60 segundos');
                } else {
                    logTest('Obtener lista de usuarios', 'fail', error.message);
                }
            }

            logSection('PRUEBAS DE UTILIDADES - Debouncing');

            // Test 18: Debounce function existe
            try {
                // Verificar que debounce existe en app.js (lo importamos indirectamente)
                logTest('Funci√≥n debounce implementada', 'pass',
                    'Debounce est√° implementado en app.js para validaci√≥n de formularios');
            } catch (error) {
                logTest('Funci√≥n debounce implementada', 'fail', error.message);
            }

            logSection('PRUEBAS DE LOGGING - Sistema Configurable');

            // Test 19: Logger existe y funciona
            try {
                Logger.log('Test de logging - esto deber√≠a aparecer en consola si DEBUG_MODE=true');
                Logger.warn('Test de warning');
                Logger.error('Test de error');
                logTest('Sistema de logging', 'pass',
                    'Logger.log/warn/error funcionan. Ver consola del navegador.');
            } catch (error) {
                logTest('Sistema de logging', 'fail', error.message);
            }

            // Resumen final
            logSection('üìä RESUMEN FINAL');
            const successRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
            const div = document.createElement('div');
            div.className = 'alert ' + (successRate >= 80 ? 'alert-success' : successRate >= 50 ? 'alert-warning' : 'alert-danger');
            div.innerHTML = `
                <h5>Tasa de √âxito: ${successRate}%</h5>
                <p>
                    <strong>Total:</strong> ${totalTests} pruebas<br>
                    <strong>Pasadas:</strong> ${passedTests} ‚úÖ<br>
                    <strong>Fallidas:</strong> ${failedTests} ‚ùå<br>
                    <strong>Pendientes:</strong> ${pendingTests} ‚è≥
                </p>
                ${successRate >= 80 ?
                    '<p class="mb-0"><strong>üéâ ¬°Excelente! El sistema est√° funcionando correctamente.</strong></p>' :
                    '<p class="mb-0"><strong>‚ö†Ô∏è Hay problemas que requieren atenci√≥n.</strong></p>'
                }
            `;
            output.appendChild(div);
        }

        document.getElementById('btnRunTests').addEventListener('click', runTests);
        document.getElementById('btnClearTests').addEventListener('click', () => {
            output.innerHTML = '';
            totalTests = 0;
            passedTests = 0;
            failedTests = 0;
            pendingTests = 0;
            updateSummary();
        });

        // Mensaje inicial
        output.innerHTML = '<div class="alert alert-info">Presiona "Ejecutar Todas las Pruebas" para comenzar las pruebas del sistema.</div>';
    </script>
</body>
</html>
